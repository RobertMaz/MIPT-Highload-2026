# NFR Framework

> Как определить архитектурно-значимые NFR
>
> Краткая версия: 3 мин | Полная версия: 15 мин

---

## Правило

> NFR архитектурно-значимый если **2 из 3 критериев = High**

---

## Таблица критериев

| Критерий                | High                    | Medium                  | Low                  |
|-------------------------|-------------------------|-------------------------|----------------------|
| **Impact на структуру** | Меняет фундамент        | Меняет компоненты       | Конфигурация         |
| **Cost of change**      | Нельзя добавить потом   | Дорого рефакторить      | Можно добавить позже |
| **Business risk**       | Потеря лицензии/бизнеса | Потеря клиентов/revenue | Жалобы               |

---

## Быстрые примеры

### ✅ Архитектурно-значимый: Availability 99.95% для банка

| Критерий | Оценка   | Обоснование                                                 |
|----------|----------|-------------------------------------------------------------|
| Impact   | **High** | Multi-AZ репликация, health checks, failover, read replicas |
| Cost     | **High** | Нельзя добавить после запуска — архитектура с первого дня   |
| Risk     | **High** | Потеря лицензии ЦБ, штрафы, уход клиентов                   |

**Вердикт:** ✅ 3/3 = High → Критичный NFR

---

### ❌ НЕ архитектурно-значимый: Темная тема UI

| Критерий | Оценка  | Обоснование                |
|----------|---------|----------------------------|
| Impact   | **Low** | Только CSS/frontend        |
| Cost     | **Low** | Добавить за 1-2 дня        |
| Risk     | **Low** | Приятно иметь, не критично |

**Вердикт:** ❌ 0/3 = High → Не влияет на архитектуру

---

## Как применять на С1

### Шаг 1: Для каждого NFR заполнить таблицу

| NFR                 | Impact | Cost | Risk | Значимый? |
|---------------------|--------|------|------|-----------|
| Availability 99.95% | H      | H    | H    | ✅ 3/3     |
| Latency p95 <200ms  | H      | H    | M    | ✅ 2/3     |
| GDPR compliance     | M      | H    | H    | ✅ 2/3     |
| Audit logging       | M      | M    | H    | ❌ 1/3     |
| Dark theme          | L      | L    | L    | ❌ 0/3     |

### Шаг 2: Выделить критичные (2+ High)

Они **обязаны** влиять на архитектурный дизайн.

---

## Частые ошибки

**❌ "Всё = High"** — если всё критично, то ничего не критично. Нужны trade-offs.

**❌ Нет обоснования** — не просто "High", а "High потому что..."

---

# Полное обоснование

> Дальше — для тех, кто хочет понять откуда взялись критерии

---

## Зачем нужен Framework

**Проблема:** На этапе сбора требований команда получает 20-50 NFR. Нельзя сделать всё идеально — ресурсы ограничены.

**Вопрос:** Какие NFR определяют архитектуру с первого дня, а какие можно добавить позже?

**Цена ошибки:**

| Ошибка                     | Последствия                            |
|----------------------------|----------------------------------------|
| Пропустил критичный NFR    | Дорогой рефакторинг или провал проекта |
| Переоценил некритичный NFR | Over-engineering, потраченные ресурсы  |

---

## Откуда критерии?

Framework — практический инструмент, синтезированный из:

| Критерий           | Источник            | Ключевая работа                                      |
|--------------------|---------------------|------------------------------------------------------|
| **Impact**         | Структурный анализ  | SEI ATAM (Architecture Tradeoff Analysis Method)     |
| **Cost of change** | Стоимость изменений | Barry Boehm's cost curves                            |
| **Business risk**  | Risk-driven design  | George Fairbanks "Just Enough Software Architecture" |

**Почему 3 критерия?**

- Меньше — не покрывает все аспекты
- Больше — слишком сложно для быстрой оценки
- 3 = баланс полноты и практичности

---

## Критерий 1: Impact на структуру

**Что измеряем:** Глубина изменений в архитектуре.

| Уровень    | Что затрагивает                                       |
|------------|-------------------------------------------------------|
| **High**   | Архитектурный стиль, базовые паттерны, инфраструктура |
| **Medium** | Добавление сервисов, модулей, интеграций              |
| **Low**    | Настройки, параметры, feature flags                   |

**Примеры:**

| NFR                   | Impact     | Почему                                     |
|-----------------------|------------|--------------------------------------------|
| Availability 99.99%   | **High**   | Multi-AZ, репликация, failover — фундамент |
| Latency p99 <50ms     | **High**   | Кэширование, CDN, async — пронизывает всё  |
| Поддержка 2 языков UI | **Medium** | i18n модуль, архитектура та же             |
| Темная тема           | **Low**    | CSS/конфигурация                           |

**Ключевой вопрос:**
> "Придётся ли менять диаграмму архитектуры?"

---

## Критерий 2: Cost of change

**Что измеряем:** Насколько дорого добавить/изменить это позже.

| Уровень    | Характеристика                                      |
|------------|-----------------------------------------------------|
| **High**   | Требует заложить с первого дня, иначе переписывание |
| **Medium** | Можно добавить, но значительные усилия              |
| **Low**    | Изменение локальное                                 |

**Примеры:**

| NFR                            | Cost       | Почему                               |
|--------------------------------|------------|--------------------------------------|
| Горизонтальное масштабирование | **High**   | Stateless с первого дня              |
| Multi-tenancy                  | **High**   | Data isolation с первого дня         |
| Rate limiting                  | **Medium** | Middleware, но нужно понять паттерны |
| Push-уведомления               | **Low**    | Новый канал в notification service   |

**Ключевой вопрос:**
> "Если через год заказчик скажет 'нужно X', сколько это будет стоить?"

### Кривая Boehm

Barry Boehm показал: стоимость изменений растёт экспоненциально.

```
Стоимость
    ^
    |                         ****
    |                    *****
    |               *****
    |          *****
    |     *****
    |*****
    +---------------------------------> Время
    Requirements  Design  Code  Test  Production
        1x          5x     10x   20x     100x
```

**High Cost of Change** = изменение в Production стоит в 100x дороже чем в Requirements.

---

## Критерий 3: Business risk

**Что измеряем:** Последствия для бизнеса если NFR не выполнен.

| Уровень    | Последствия                                   |
|------------|-----------------------------------------------|
| **High**   | Регуляторные санкции, банкротство, уголовка   |
| **Medium** | Отток пользователей, упущенная выручка        |
| **Low**    | Негативные отзывы, бизнес продолжает работать |

**Примеры:**

| NFR                      | Risk       | Почему                                 |
|--------------------------|------------|----------------------------------------|
| PCI DSS compliance       | **High**   | Без сертификата нельзя принимать карты |
| GDPR compliance          | **High**   | Штрафы до 4% годового оборота          |
| Latency <2s (e-commerce) | **Medium** | Каждая секунда = -7% конверсии         |
| Темная тема              | **Low**    | Недовольны, но не уходят               |

**Ключевой вопрос:**
> "Что случится с бизнесом если провалим?"

---

## Почему порог "2 из 3"?

| Сколько High | Логика                                                                                               |
|--------------|------------------------------------------------------------------------------------------------------|
| **3 из 3**   | Очевидно критично                                                                                    |
| **2 из 3**   | Достаточно серьёзно: High Impact + High Cost, или High Impact + High Risk, или High Cost + High Risk |
| **1 из 3**   | Можно отложить                                                                                       |
| **0 из 3**   | Точно не архитектурный приоритет                                                                     |

**Почему не другие пороги?**

| Порог              | Проблема                             |
|--------------------|--------------------------------------|
| "Все 3 = High"     | Слишком строгий — пропустим важное   |
| "Хотя бы 1 = High" | Слишком мягкий — всё станет значимым |
| "2 из 3"           | Баланс                               |

---

## Связь с выбором решений

NFR с 2+ High → определяет класс решения:

| NFR                 | Влияние на архитектуру                      |
|---------------------|---------------------------------------------|
| Availability 99.95% | Multi-AZ, replicas, failover, health checks |
| Latency p99 <100ms  | Caching, CDN, async, connection pooling     |
| Throughput >10K RPS | Horizontal scaling, stateless, sharding     |
| GDPR compliance     | Encryption, audit logs, право на забвение   |

---

## Ограничения

1. **Это эвристика, не алгоритм** — требует judgment
2. **Критерии могут иметь разный вес** — в банках Risk важнее Impact
3. **Контекст решает** — один NFR может быть High для банка и Low для стартапа

---

## Резюме

```
┌─────────────────────────────────────────────────────────┐
│   NFR архитектурно-значимый если 2+ из 3 = High        │
│                                                         │
│   ┌─────────────┬─────────────┬─────────────┐          │
│   │   Impact    │    Cost     │    Risk     │          │
│   │  структура  │  изменений  │   бизнеса   │          │
│   └─────────────┴─────────────┴─────────────┘          │
│                                                         │
│   2+ High = ✅ Архитектурный приоритет                 │
│   1 High  = ❌ Можно отложить                          │
└─────────────────────────────────────────────────────────┘
```
